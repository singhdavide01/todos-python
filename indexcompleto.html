<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Todo App FastAPI + Login</title>

  <style>
    body { 
      background:#111; 
      color:white; 
      font-family:Arial; 
      padding:20px; 
    }
    input {
      padding:10px;
      width:70%;
      border-radius:8px;
      border:none;
      margin:5px 0;
    }
    button {
      padding:10px 15px;
      background:#4caf50;
      border:none;
      color:white;
      border-radius:8px;
      cursor:pointer;
    }
    button:hover { opacity:0.9; }
    li {
      background:#222;
      padding:10px;
      margin-top:10px;
      border-radius:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .delete { background:red; border:none; padding:5px 10px; border-radius:5px; color:white; cursor:pointer; }
    #loginSection, #todoSection { margin-bottom:20px; }
    .small { font-size:0.9rem; color:#bbb; margin-top:6px; }
  </style>
</head>
<body>

<h1>Todo App FastAPI</h1>

<div id="loginSection">
  <h2>Login</h2>
  <input id="username" placeholder="Username (tim)" value="tim">
  <input type="password" id="password" placeholder="Password (secret)" value="secret">
  <button onclick="login()">Login</button>
  <div id="loginMsg" class="small"></div>
</div>

<div id="todoSection" style="display:none;">
  <h2>Todo List</h2>
  <input id="todoInput" placeholder="Nuova attivitÃ ..." />
  <button onclick="addTodo()">Aggiungi</button>
  <ul id="todoList"></ul>
  <button onclick="logout()" style="margin-top:10px; background:#f44336;">Logout</button>
</div>

<script>
const API = "http://127.0.0.1:8000";
let token = "";

// helper: show message
function showMsg(msg) {
  document.getElementById("loginMsg").textContent = msg;
}

// LOGIN
async function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;

  const formData = new URLSearchParams();
  formData.append("username", username);
  formData.append("password", password);

  try {
    const res = await fetch(`${API}/token`, {
      method: "POST",
      body: formData,
      headers: { "Content-Type": "application/x-www-form-urlencoded" }
    });

    if (!res.ok) {
      const err = await res.json().catch(()=>null);
      throw new Error(err?.detail || "Login fallito");
    }

    const data = await res.json();
    token = data.access_token;
    showMsg("Login riuscito!");

    // mostra todo section
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("todoSection").style.display = "block";

    loadTodos();

  } catch (err) {
    showMsg(err.message || err);
  }
}

// LOGOUT
function logout() {
  token = "";
  document.getElementById("loginSection").style.display = "block";
  document.getElementById("todoSection").style.display = "none";
  document.getElementById("loginMsg").textContent = "";
  document.getElementById("todoList").innerHTML = "";
}

// LOAD TODOS
async function loadTodos() {
  try {
    const res = await fetch(`${API}/todos`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!res.ok) {
      throw new Error("Errore caricamento todo");
    }
    const todos = await res.json();

    const list = document.getElementById("todoList");
    list.innerHTML = "";

    todos.forEach(t => {
      list.innerHTML += `
        <li id="li-${t.id}">
          <span>${escapeHtml(t.title)}</span>
          <div>
            <button onclick="editTodo(${t.id}, '${t.title.replace(/'/g,"\\'").replace(/"/g,'\\"')}')">EDIT</button>
            <button class="delete" onclick="deleteTodo(${t.id})">X</button>
          </div>
        </li>`;
    });

  } catch(err) {
    console.error(err);
    showMsg(err.message || err);
  }
}

// ADD TODO
async function addTodo() {
  const title = document.getElementById("todoInput").value.trim();
  if (!title) return;

  try {
    const res = await fetch(`${API}/todos`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({title})
    });

    if (!res.ok) {
      const err = await res.json().catch(()=>null);
      throw new Error(err?.detail || "Errore aggiunta");
    }

    document.getElementById("todoInput").value = "";
    loadTodos();
  } catch (err) {
    showMsg(err.message || err);
  }
}

// DELETE TODO
async function deleteTodo(id) {
  try {
    const res = await fetch(`${API}/todos/${id}`, {
      method: "DELETE",
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>null);
      throw new Error(err?.detail || "Errore eliminazione");
    }
    loadTodos();
  } catch (err) {
    showMsg(err.message || err);
  }
}

// EDIT TODO
async function editTodo(id, oldTitle) {
  const newTitle = prompt("Modifica la todo:", oldTitle);
  if (!newTitle || newTitle.trim() === "") return;

  try {
    const res = await fetch(`${API}/todos/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({title: newTitle})
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>null);
      throw new Error(err?.detail || "Errore aggiornamento");
    }
    loadTodos();
  } catch (err) {
    showMsg(err.message || err);
  }
}

// small helper to avoid HTML injection in list
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>

</body>
</html>
